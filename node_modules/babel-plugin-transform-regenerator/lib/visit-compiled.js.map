{"version":3,"sources":["visit.js"],"names":[],"mappings":"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","file":"visit-compiled.js","sourcesContent":["\"use strict\";\n\nvar _assert = require(\"assert\");\n\nvar _assert2 = _interopRequireDefault(_assert);\n\nvar _babelTypes = require(\"babel-types\");\n\nvar t = _interopRequireWildcard(_babelTypes);\n\nvar _hoist = require(\"./hoist\");\n\nvar _emit = require(\"./emit\");\n\nvar _util = require(\"./util\");\n\nvar util = _interopRequireWildcard(_util);\n\nfunction _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nvar getMarkInfo = require(\"private\").makeAccessor();\n\nexports.visitor = {\n  Function: {\n    exit: function exit(path, state) {\n      var node = path.node;\n\n      if (node.generator) {\n        if (node.async) {\n          if (state.opts.asyncGenerators === false) return;\n        } else {\n          if (state.opts.generators === false) return;\n        }\n      } else if (node.async) {\n        if (state.opts.async === false) return;\n      } else {\n        return;\n      }\n\n      var contextId = path.scope.generateUidIdentifier(\"context\");\n      var argsId = path.scope.generateUidIdentifier(\"args\");\n\n      path.ensureBlock();\n      var bodyBlockPath = path.get(\"body\");\n\n      if (node.async) {\n        bodyBlockPath.traverse(awaitVisitor);\n      }\n\n      bodyBlockPath.traverse(functionSentVisitor, {\n        context: contextId\n      });\n\n      var outerBody = [];\n      var innerBody = [];\n\n      bodyBlockPath.get(\"body\").forEach(function (childPath) {\n        var node = childPath.node;\n        if (node && node._blockHoist != null) {\n          outerBody.push(node);\n        } else {\n          innerBody.push(node);\n        }\n      });\n\n      if (outerBody.length > 0) {\n        bodyBlockPath.node.body = innerBody;\n      }\n\n      var outerFnExpr = getOuterFnExpr(path);\n\n      t.assertIdentifier(node.id);\n      var innerFnId = t.identifier(node.id.name + \"$\");\n\n      var vars = (0, _hoist.hoist)(path);\n\n      var didRenameArguments = renameArguments(path, argsId);\n      if (didRenameArguments) {\n        vars = vars || t.variableDeclaration(\"var\", []);\n        vars.declarations.push(t.variableDeclarator(argsId, t.identifier(\"arguments\")));\n      }\n\n      var emitter = new _emit.Emitter(contextId);\n      emitter.explode(path.get(\"body\"));\n\n      if (vars && vars.declarations.length > 0) {\n        outerBody.push(vars);\n      }\n\n      var wrapArgs = [emitter.getContextFunction(innerFnId), node.generator ? outerFnExpr : t.nullLiteral(), t.thisExpression()];\n\n      var tryLocsList = emitter.getTryLocsList();\n      if (tryLocsList) {\n        wrapArgs.push(tryLocsList);\n      }\n\n      var wrapCall = t.callExpression(util.runtimeProperty(node.async ? \"async\" : \"wrap\"), wrapArgs);\n\n      outerBody.push(t.returnStatement(wrapCall));\n      node.body = t.blockStatement(outerBody);\n\n      var wasGeneratorFunction = node.generator;\n      if (wasGeneratorFunction) {\n        node.generator = false;\n      }\n\n      if (node.async) {\n        node.async = false;\n      }\n\n      if (wasGeneratorFunction && t.isExpression(node)) {\n        path.replaceWith(t.callExpression(util.runtimeProperty(\"mark\"), [node]));\n      }\n\n      path.requeue();\n    }\n  }\n};\n\nfunction getOuterFnExpr(funPath) {\n  var node = funPath.node;\n  t.assertFunction(node);\n\n  if (!node.id) {\n    node.id = funPath.scope.parent.generateUidIdentifier(\"callee\");\n  }\n\n  if (node.generator && t.isFunctionDeclaration(node)) {\n    var pp = funPath.findParent(function (path) {\n      return path.isProgram() || path.isBlockStatement();\n    });\n\n    if (!pp) {\n      return node.id;\n    }\n\n    var markDecl = getRuntimeMarkDecl(pp);\n    var markedArray = markDecl.declarations[0].id;\n    var funDeclIdArray = markDecl.declarations[0].init.callee.object;\n    t.assertArrayExpression(funDeclIdArray);\n\n    var index = funDeclIdArray.elements.length;\n    funDeclIdArray.elements.push(node.id);\n\n    return t.memberExpression(markedArray, t.numericLiteral(index), true);\n  }\n\n  return node.id;\n}\n\nfunction getRuntimeMarkDecl(blockPath) {\n  var block = blockPath.node;\n  _assert2.default.ok(Array.isArray(block.body));\n\n  var info = getMarkInfo(block);\n  if (info.decl) {\n    return info.decl;\n  }\n\n  info.decl = t.variableDeclaration(\"var\", [t.variableDeclarator(blockPath.scope.generateUidIdentifier(\"marked\"), t.callExpression(t.memberExpression(t.arrayExpression([]), t.identifier(\"map\"), false), [util.runtimeProperty(\"mark\")]))]);\n\n  blockPath.unshiftContainer(\"body\", info.decl);\n\n  return info.decl;\n}\n\nfunction renameArguments(funcPath, argsId) {\n  var state = {\n    didRenameArguments: false,\n    argsId: argsId\n  };\n\n  funcPath.traverse(argumentsVisitor, state);\n\n  return state.didRenameArguments;\n}\n\nvar argumentsVisitor = {\n  \"FunctionExpression|FunctionDeclaration\": function FunctionExpressionFunctionDeclaration(path) {\n    path.skip();\n  },\n\n  Identifier: function Identifier(path, state) {\n    if (path.node.name === \"arguments\" && util.isReference(path)) {\n      path.replaceWith(state.argsId);\n      state.didRenameArguments = true;\n    }\n  }\n};\n\nvar functionSentVisitor = {\n  MetaProperty: function MetaProperty(path) {\n    var node = path.node;\n\n\n    if (node.meta.name === \"function\" && node.property.name === \"sent\") {\n      path.replaceWith(t.memberExpression(this.context, t.identifier(\"_sent\")));\n    }\n  }\n};\n\nvar awaitVisitor = {\n  Function: function Function(path) {\n    path.skip();\n  },\n\n  AwaitExpression: function AwaitExpression(path) {\n    var argument = path.node.argument;\n\n    path.replaceWith(t.yieldExpression(t.callExpression(util.runtimeProperty(\"awrap\"), [argument]), false));\n  }\n};"]}